<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<!--  <script th:inline="javascript" src="/js/test.js"></script>-->
  <meta charset="UTF-8">
  <title>Board Detail</title>

  <style>
    img {
      max-width: 100%;
      max-height: 100vh;
    </style>
</head>
<body>

<h2>Board Detail</h2>

<div th:if="${board}">
  <p><strong>Title:</strong> <span th:text="${board.title}"></span></p>
  <p><strong>Content:</strong> <span th:utext="${board.content}"></span></p>

  <!-- 게시글의 첨부 파일 목록 -->
  <div th:if="${board.boardFileDtoList}">
    <p><strong>Attachments:</strong></p>
    <ul>
      <li th:each="file : ${board.boardFileDtoList}">
        <a th:href="@{'/boardFile/download/' + ${file.id}}" th:text="${file.originalFileName}"></a>
      </li>
    </ul>
  </div>

  <!-- 수정 버튼 -->
  <a th:href="@{'/board/' + ${board.id} + '/edit'}">Edit</a>

  <!-- 삭제 버튼 -->
  <form th:action="@{'/board/' + ${board.id} + '/delete'}" method="post">
    <input type="hidden" name="_method" value="delete" />
    <button type="submit">Delete</button>
  </form>


  <!--좋아요-->
  <div sec:authorize-expr="isAuthenticated()" and th:unless="${#strings.equals(board.getWriter(),#authentication.name)}" class="d-block">
    <!-- 로그인 유저와 작성자가 동일하지 않다면 -->
    <!-- 좋아요 -->
    <h2>로그인을 했고, 로그인 유저 != 게시글 작성자</h2>
    <input type="hidden" id="like_check" th:value="${like}">
    <img th:id="likeImg" src="/assets/img/empty.png" alt="" width="30px"
         height="30px">
    <span th:text="${board.likeCount}"></span>
  </div>

    <!--좋아요-->
    <div sec:authorize-expr="isAuthenticated()" th:if="${#strings.equals(board.getWriter(),#authentication.name)}" class="d-block">
      <!-- 로그인 유저와 작성자가 같다면 -->
      <!-- 좋아요 -->
      <h2>로그인을 했고, 로그인 유저 == 게시글 작성자</h2>
      <img th:id="likeImg" src="/assets/img/empty.png" alt="" width="30px"
           height="30px">
    <span th:text="${board.likeCount}"></span>
  </div>

  <div sec:authorize-expr="!isAuthenticated()">
    <!-- 로그인하지 않은 유저라면 -->
    <h2>비로그인 유저</h2>
    <img id="loginCheck" src="/assets/img/empty.png" alt="" width="30px"
         height="30px">
    <span th:text="${board.likeCount}"></span>
  </div>


  <div th:unless="${board}">
    <p>게시글이 존재하지 않습니다.</p>
  </div>

  <script th:inline="javascript">
    window.onload = function () {
  const clickLikeUrl = "/assets/img/full.jpeg";
  const emptyLikeUrl = "/assets/img/empty.png";
  console.log([[${#authentication.name}]]);

  if([[${#authentication.name}]] === "anonymousUser"){
  document.getElementById('loginCheck').addEventListener('click', function () {
      alert("로그인 후 이용할 수 있습니다.");
  });
  }

  updateLikeImage();

  document.getElementById('likeImg').addEventListener('click', function () {
      const boardId = /*[[${board.id}]]*/;
      const likeVal = document.getElementById('like_check').value;

      if (likeVal === 'true') {
          const conCheck = confirm("현재 게시물 추천을 취소하시겠습니까?");
          if (conCheck) {
              sendLikeRequest(boardId, emptyLikeUrl);
          }
      } else if (likeVal === 'false') {
          const conCheck = confirm("현재 게시물을 추천하시겠습니까?");
          if (conCheck) {
              sendLikeRequest(boardId, clickLikeUrl);
          }
      }
  });


  function updateLikeImage() {
      let likeVal = document.getElementById('like_check').value;
      if (likeVal === 'true') {
          document.getElementById('likeImg').src = clickLikeUrl;
      } else if (likeVal === 'false') {
          document.getElementById('likeImg').src = emptyLikeUrl;
      }
  }

  function sendLikeRequest(boardId, imageUrl) {
      fetch(`/like/${boardId}`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json; charset=utf-8'
          },
      })
          .then(response => response.json())
          .then(data => {
              document.getElementById('likeImg').src = imageUrl;
              location.reload();
          })
          .catch(error => {
              alert(JSON.stringify(error));
          });
  }
};
  </script>
</body>
</html>